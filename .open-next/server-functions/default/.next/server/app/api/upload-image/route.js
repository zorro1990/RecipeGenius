(()=>{var e={};e.id=893,e.ids=[893],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5487:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>d,POST:()=>c,dynamic:()=>l});var n=r(6559),o=r(8088),i=r(7719),a=r(2190),u=r(5807);async function c(e){try{var t,r,s,n;(0,u.Rm)("info","开始图片上传处理");let o=e.headers.get("content-type");if(!o?.includes("multipart/form-data"))return a.NextResponse.json({success:!1,error:"请使用multipart/form-data格式上传图片"},{status:400});let i=(await e.formData()).get("image");if(!i)return a.NextResponse.json({success:!1,error:"未找到图片文件"},{status:400});let c=["image/jpeg","image/png","image/webp"];if(!c.includes(i.type))return a.NextResponse.json({success:!1,error:`不支持的文件格式。支持的格式：${c.map(e=>e.split("/")[1].toUpperCase()).join(", ")}`},{status:400});if(i.size>5242880)return a.NextResponse.json({success:!1,error:`文件过大。最大允许5MB，当前文件${(i.size/1024/1024).toFixed(2)}MB`},{status:400});(0,u.Rm)("info","文件验证通过",{fileName:i.name,fileSize:i.size,fileType:i.type});let d=await i.arrayBuffer(),l=new Uint8Array(d),p=new Blob([l],{type:i.type}),m=await (t=p,new Promise((e,r)=>{let s=new FileReader;s.onload=()=>e(s.result),s.onerror=r,s.readAsDataURL(t)})),g=await (r=m,new Promise((e,t)=>{let s=new Image;s.onload=()=>{e({width:s.width,height:s.height})},s.onerror=t,s.src=r}));if(g.width>4096||g.height>4096)return a.NextResponse.json({success:!1,error:`图片尺寸过大。最大允许4096x4096，当前图片${g.width}x${g.height}`},{status:400});let f=m,w=i.size;if(i.size>1048576||g.width>1024||g.height>1024)try{let e=await (s=m,n={maxWidth:1024,maxHeight:1024,quality:.8},new Promise((e,t)=>{let{maxWidth:r=1024,maxHeight:o=1024,quality:i=.8}=n,a=document.createElement("canvas"),u=a.getContext("2d"),c=new Image;c.onload=()=>{try{let{width:t,height:s}=c;t>s?t>r&&(s=s*r/t,t=r):s>o&&(t=t*o/s,s=o),a.width=t,a.height=s,u?.drawImage(c,0,0,t,s);let n=a.toDataURL("image/jpeg",i),d=Math.round(3*n.length/4);e({dataUrl:n,size:d})}catch(e){t(e)}},c.onerror=t,c.src=s}));f=e.dataUrl,w=e.size,(0,u.Rm)("info","图片压缩完成",{originalSize:i.size,compressedSize:w,compressionRatio:((i.size-w)/i.size*100).toFixed(2)+"%"})}catch(e){(0,u.Rm)("warn","图片压缩失败，使用原图",{error:e instanceof Error?e.message:"Unknown error"})}let h=i.size>0?(i.size-w)/i.size:0;return(0,u.Rm)("info","图片上传处理完成",{originalSize:i.size,compressedSize:w,compressionRatio:(100*h).toFixed(2)+"%",dimensions:g}),a.NextResponse.json({success:!0,data:{imageDataUrl:f,originalSize:i.size,compressedSize:w,compressionRatio:h,format:i.type,dimensions:g}})}catch(e){return(0,u.Rm)("error","图片上传处理失败",{error:e instanceof Error?e.message:"Unknown error"}),a.NextResponse.json({success:!1,error:"图片处理失败",message:"请重试或选择其他图片"},{status:500})}}async function d(){return a.NextResponse.json({status:"ok",service:"image-upload",timestamp:new Date().toISOString(),supportedFormats:["image/jpeg","image/png","image/webp"],maxFileSize:"5MB",maxDimensions:"4096x4096"})}let l="force-dynamic",p=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/upload-image/route",pathname:"/api/upload-image",filename:"route",bundlePath:"app/api/upload-image/route"},resolvedPagePath:"/Users/zorro/Documents/augment-projects/cooker/recipe-genius/app/api/upload-image/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:f}=p;function w(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}},5807:(e,t,r)=>{"use strict";function s(){return void 0!==globalThis.caches&&void 0!==globalThis.Request&&void 0!==globalThis.Response&&void 0!==globalThis.fetch}function n(e,t){return s()&&"undefined"!=typeof globalThis?globalThis[e]||t:"undefined"!=typeof process&&process.env&&process.env[e]||t}function o(e){let t=n(e);if(t&&"undefined"!==t&&"null"!==t)return t}r.d(t,{Eb:()=>p,LF:()=>i,QU:()=>d,Rm:()=>c,WX:()=>u,co:()=>a,de:()=>s,e$:()=>o,lh:()=>n,xd:()=>m});function i(e){let t=e.headers,r=e.cf||{};return{id:`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),userAgent:t.get("user-agent")||void 0,ip:t.get("cf-connecting-ip")||t.get("x-forwarded-for")||void 0,country:r.country||void 0,region:r.region||void 0,city:r.city||void 0}}function a(e,t,r){let s=new Headers(e.headers);if(Object.entries(t).forEach(([e,t])=>{void 0!==t&&s.set(e,t)}),r?.id&&s.set("X-Request-ID",r.id),r?.timestamp){let e=Date.now()-r.timestamp;s.set("X-Response-Time",`${e}ms`)}return new Response(e.body,{status:e.status,statusText:e.statusText,headers:s})}function u(e,t,r,s){let n={success:!1,error:t,details:r,timestamp:new Date().toISOString(),requestId:s?.id},o={"Content-Type":"application/json","X-Request-ID":s?.id};if(s?.timestamp){let e=Date.now()-s.timestamp;o["X-Response-Time"]=`${e}ms`}return new Response(JSON.stringify(n),{status:e,headers:o})}function c(e,t,r,s){let n={level:e,message:t,timestamp:new Date().toISOString(),requestId:s,metadata:r};switch(e){case"debug":case"info":break;case"warn":console.warn(JSON.stringify(n));break;case"error":console.error(JSON.stringify(n))}}function d(e,t=["*"]){let r=e.headers.get("Origin");if("OPTIONS"===e.method){let e=new Headers;return(t.includes("*")||r&&t.includes(r))&&e.set("Access-Control-Allow-Origin",r||"*"),e.set("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),e.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e.set("Access-Control-Max-Age","86400"),new Response(null,{status:204,headers:e})}return null}let l=new Map;function p(e,t=100,r=6e4){let s=Date.now(),n=l.get(e);return!n||s>n.resetTime?(l.set(e,{count:1,resetTime:s+r}),!0):!(n.count>=t)&&(n.count++,!0)}function m(e,t,r){let s=Date.now();return e().then(e=>{let n=Date.now()-s;return c("info",`Performance: ${t} completed in ${n}ms`,{operation:t,duration:n,success:!0},r?.id),e},e=>{let n=Date.now()-s;throw c("error",`Performance: ${t} failed in ${n}ms`,{operation:t,duration:n,success:!1,error:e.message},r?.id),e})}},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,580],()=>r(5487));module.exports=s})();