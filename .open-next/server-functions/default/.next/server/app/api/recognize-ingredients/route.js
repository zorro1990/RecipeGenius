"use strict";(()=>{var e={};e.id=981,e.ids=[981],e.modules={846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},939:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>w,routeModule:()=>g,serverHooks:()=>f,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>x});var t={};s.r(t),s.d(t,{GET:()=>m,POST:()=>d,dynamic:()=>p});var n=s(6559),o=s(8088),a=s(7719),i=s(2190),u=s(5697),c=s(5807);async function d(e){let r=Date.now();try{(0,c.Rm)("info","开始图片食材识别请求");let{imageDataUrl:s,apiKeys:t,options:n={}}=await e.json();if(!s)return i.NextResponse.json({success:!1,error:"缺少图片数据"},{status:400});if(!s.startsWith("data:image/"))return i.NextResponse.json({success:!1,error:"无效的图片格式"},{status:400});let o=3*s.length/4/1048576;if(o>10)return i.NextResponse.json({success:!1,error:"图片过大，请选择小于10MB的图片"},{status:400});(0,c.Rm)("info","图片验证通过",{imageSizeInMB:o.toFixed(2),hasApiKeys:!!t?.doubao});let a=n.timeout||3e4,d=n.maxRetries||2,m=null;for(let e=1;e<=d;e++)try{(0,c.Rm)("info",`尝试识别食材 (第${e}次)`,{attempt:e,maxRetries:d});let n=new Promise((e,r)=>{setTimeout(()=>r(Error("请求超时")),a)}),o=(0,u.Gf)(s,t),m=await Promise.race([o,n]),p=Date.now()-r;return(0,c.Rm)("info","食材识别成功",{ingredientsCount:m.ingredients.length,confidence:m.confidence,processingTime:p,attempt:e}),i.NextResponse.json({success:!0,data:{...m,processingTime:p}})}catch(r){m=r instanceof Error?r:Error("Unknown error"),(0,c.Rm)("warn",`食材识别失败 (第${e}次)`,{attempt:e,maxRetries:d,error:m.message}),e<d&&await new Promise(r=>setTimeout(r,1e3*e))}let p=Date.now()-r;(0,c.Rm)("error","食材识别最终失败",{maxRetries:d,processingTime:p,finalError:m?.message});let g="食材识别失败，请重试",l=500;return m&&(m.message.includes("未配置")||m.message.includes("API密钥")?(g="豆包API未配置，请在设置中配置API密钥",l=400):m.message.includes("超时")?(g="识别超时，请重试或选择更小的图片",l=408):m.message.includes("格式")||m.message.includes("解析")?(g="图片格式不支持或已损坏",l=400):(m.message.includes("网络")||m.message.includes("连接"))&&(g="网络连接失败，请检查网络后重试",l=503)),i.NextResponse.json({success:!1,error:g,message:`处理时间: ${p}ms`},{status:l})}catch(s){let e=Date.now()-r;return(0,c.Rm)("error","图片识别API异常",{error:s instanceof Error?s.message:"Unknown error",processingTime:e}),i.NextResponse.json({success:!1,error:"服务器内部错误",message:"请稍后重试"},{status:500})}}async function m(){try{let{testDoubaoVisionConnection:e}=await Promise.resolve().then(s.bind(s,5697)),r=await e();return i.NextResponse.json({status:"ok",service:"ingredient-recognition",timestamp:new Date().toISOString(),doubaoVision:{available:r.success,message:r.message}})}catch(e){return i.NextResponse.json({status:"error",service:"ingredient-recognition",timestamp:new Date().toISOString(),error:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p="force-dynamic",g=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/recognize-ingredients/route",pathname:"/api/recognize-ingredients",filename:"route",bundlePath:"app/api/recognize-ingredients/route"},resolvedPagePath:"/Users/zorro/Documents/augment-projects/cooker/recipe-genius/app/api/recognize-ingredients/route.ts",nextConfigOutput:"standalone",userland:t}),{workAsyncStorage:l,workUnitAsyncStorage:x,serverHooks:f}=g;function w(){return(0,a.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:x})}},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[447,580,117],()=>s(939));module.exports=t})();